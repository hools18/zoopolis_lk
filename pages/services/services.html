<template>
    <div class="page service">
		<div class="page-content">
			<div class="head">
				<div class="container">
					<div class="row">
						<div class="col-100 small-100 medium-100 large-100 xlarge-100">
							<h1 class="headTitle">Услуги</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="">
				<div class="container">
					<div class="row">
						<div class="col-100 small-100 medium-100 large-100 xlarge-100">

							<div class="toolbar tabbar toolbar-bottom">
								<div class="toolbar-inner">
									<a href="#zooid" class="tab-link tab-link-active">Зоо ID</a>
									<a href="#concierge" class="tab-link">Зооконсьерж</a>
									<a href="#history" class="tab-link">История</a>
									<a href="#appeals" class="tab-link">Индивидуальный запрос</a>
								</div>
							</div>
							<div class="tabs">
								<div id="zooid" class="page-content tab tab-active">
									<div class="wrap">
										<div class="serviceslist">
											<div class="row">
												<div class="item" >
													<div class="row">
														<div class="col-100 data">
															<div>
																<div class="name">Сообщить о пропаже</div>
															</div>
															<div>
																<div class="action">
																	<a class="external" href="tel:88011008080">Позвонить <img src="assets/icon_more.svg" /></a>
																	<div class="" @click=${missinganimal}>Оставить заявку <img src="assets/icon_more.svg" /></div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="concierge" class="page-content tab">
									<div class="wrap">
										<form class="filter" id="filterPromo" name="filterPromo">
											<label class="item-checkbox item-content">
												<input type="checkbox" name="filter" value="1"/>
												<div class="item-inner">
													<div class="item-title">Все услуги</div>
												</div>
											</label>
											<label class="item-checkbox item-content">
												<input type="checkbox" name="filter" value="2"/>
												<div class="item-inner">
													<div class="item-title">Ветеринария</div>
												</div>
											</label>
											<label class="item-checkbox item-content">
												<input type="checkbox" name="filter" value="3"/>
												<div class="item-inner">
													<div class="item-title">Зоотакси</div>
												</div>
											</label>
										</form>
										<div class="serviceslist">
											<div class="row">
												<div class="item">
													<div class="row">
														<div class="col-100 data" @click=${showVeterinaryClinics}>
															<div>
																<div class="name">Информация о вет. клиниках</div>
															</div>
															<div>
																<div class="action">
																	<div class="">Выбрать <img src="assets/icon_more.svg" /></div>
																</div>
															</div>
														</div>
													</div>
												</div>
												<div class="item" data-id="1" @click=${showPromo}>
													<div class="row">
														<div class="col-100 data">
															<div>
																<div class="name">Подбор вет. врача</div>
															</div>
															<div>
																<div class="action">
																	<div class="">Выбрать <img src="assets/icon_more.svg" /></div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div id="history" class="page-content tab">
									<div class="wrap">
										<div class="section">
											<div class="name">Пропажа животного</div>
											<div class="card data-table">
												<form class="filter" id="missinganimalList" name="missinganimalList">
													<table>
														<thead>
															<tr>
																<th class="label-cell">#</th>
																<th class="numeric-cell" style="width: 13em;">Дата</th>
																<th class="numeric-cell">Текст</th>
																<th class="numeric-cell" style="width: 13em;">Статус</th>

															</tr>
														</thead>
														<tbody>
															${missinganimalList.map((data, index) => $h`
															<tr>
																<td class="label-cell">${data.id}</td>
																<td class="numeric-cell">${data.date}</td>
																<td class="numeric-cell">
																	<div class="text" innerHTML=${data.text}></div>
																</td>
																<td class="numeric-cell">
																	${data.status ? $h`
																		<div class="active"><span></span>Обработано</div>
																	` : $h`
																		<div class="deactive">В очереди</div>
																	`}
																</td>

															</tr>
															`)}
														</tbody>
													</table>
												</form>
											</div>
										</div>
									</div>
								</div>
								<div id="appeals" class="page-content tab">
									<div class="wrap">
										Индивидуальный запрос
									</div>
								</div>
							</div>
						</div>

					</div>

				</div>
			</div>
		</div>

		<div class="sheet-modal modal-promoinfo">
			<div class="hat"><a class="link sheet-close" href="#"></a></div>
			<div class="sheet-modal-inner">

				<div class="info">
					<div class="title">${promo.title}</div>
					<div class="shortdesc">
						<div class="sale">${promo.percent}%</div> ${promo.shortdesc}
					</div>
					<div class="time">До ${promo.stoptextdata} (${promo.stoptext})</div>
				</div>
				<div class="gotocode">
					<div class="promocode link" code="${promo.promocode}"  @click=${promocode}>
						<div class="label">Промокод</div>
						<div class="pers">${promo.percent}%</div>
						<img class="copy" src="assets/icon_copy.svg"/>
					</div>
					<div class="promolink"><a href="${promo.promolink}" target="_blank" class="col button button-fill external link">К покупкам</a></div>
				</div>
				<div class="сonditions">
					<div>
						<div class="title">Условия</div>
						<div class="desc" innerHTML=${promo.сonditions}></div>
					</div>
					<div>
						<div class="other">Срок действия</div>
						<div class="desc">${promo.starttextdata} - ${promo.stoptextdata} (${promo.stoptext})</div>
					</div>
					<div>
						<div class="other">Минимальная сумма покупки</div>
						<div class="desc upp">${promo.minprice} ${promo.currency}</div>
					</div>
				</div>
			</div>
		</div>
		<div class="sheet-modal modal-missinganimal">
			<div class="hat"><a class="link sheet-close" href="#"></a></div>
			<div class="sheet-modal-inner">

				<div class="info">
					<div class="title">Сообщить о пропаже</div>
				</div>
				<form class="userforms" id="missinganimal" name="missinganimal">
					<div class="сonditions">
						<div class="name">Расскажите что произошло</div>
						<div class="flexzone">
							<div class="text-editor text-editor-init missinganimaltext" data-placeholder="Расскажите что произошло"
								data-buttons='["bold", "italic", "underline", "strikeThrough"]' data-mode="popover"
								style="--f7-text-editor-height: 150px">
								<div class="text-editor-content" contenteditable></div>
							</div>
						</div>
					</div>
				</form>
				<div class="sendform">
					<div class="promolink"><a href="#" class="col button button-fill link" @click=${sendMissinganimal}>Отправить заявку</a></div>
				</div>
			</div>
		</div>
		<div class="sheet-modal modal-veterinary-clinics">
			<div class="hat"><a class="link sheet-close" href="#"></a></div>
			<div class="sheet-modal-inner">

				<div class="info">
					<div class="title">Информация о вет. клиниках</div>
					<div class="desc">Мы выступаем посредником между клиниками и вами. Предоставляем сервис, где вы в одном месте можете получить всю нужную для себя информацию</div>
				</div>
				<div class="headmap row">
					<div class="col-50">
						<div class="title">Адреса</div>
					</div>
					<div class="col-50">
						<div class="desc count">${maplist.count}</div>
					</div>
				</div>
				<div class="segmented">
					<a href="#clinicsyandex" class="tab-link button tab-link-active">Карта</a>
					<a href="#clinicslist" class="tab-link button">Список</a>
				</div>
				<div class="tabs">
					<div class="tab tab-active" id="clinicsyandex">
						<div id="veterinaryclinicsmap"></div>
					</div>
					<div class="tab" id="clinicslist">
						<div class="clinicscards row">
						${maplistdata.map((data, index) => $h`
								<a href="${data.link}" target="_blank" class="col-50 link external card">
									<div class="name">${data.name}</div>
									<div class="time" innerHTML=${data.timework}></div>
									<div class="addr">${data.addr}</div>
									<div class="link">Перейти на сайт</div>
								</a>

						`)}
						</div>
					</div>

				</div>

			</div>
		</div>
    </div>

</template>
<script>
export default (props, { $f7, $f7router, $el, $update, $on, $onBeforeMount, $onMounted, $onBeforeUpdate, $onUpdated, $onBeforeUnmount, $onUnmounted, $store, $context}) => {
	let subscriptionName = 'Зоо ID';
	let promolist = [];
	let promo = [];

    let missinganimalList = [];
	let maplist = [];
	let maplistdata = [];
	maplist['count'] = '0 адресов';
	function missinganimal(){
		$f7.sheet.open('.modal-missinganimal');
	}
	function showPromo(e){
		$f7.preloader.show();
		getid = e.target.getAttribute('data-id');
		$f7.request.postJSON(apiServer+'promo', {id: getid}).then(function (res) {
			if(res.data){
				if(res.data.err){
					$f7.preloader.hide();
					$store.dispatch('msgalert', {err: res.data.err});
				} else {
					$f7.preloader.hide();
					data = res.data;


					data.stoptext = moment(data.stop, "YYYYMMDD").fromNow();
					data.stoptextdata = moment(data.stop, "YYYYMMDD").format('D MMMM');

					data.starttext = moment(data.start, "YYYYMMDD").fromNow();
					data.starttextdata = moment(data.start, "YYYYMMDD").format('D MMMM');
					promo = data;
					$update();
					$f7.sheet.open('.modal-promoinfo');
				}
			} else {
				$f7.preloader.hide();
				$store.dispatch('msgalert', {err: 'Попробуйте позже.'});
			}
		});
	};
	function startLoadPromo(){
		$f7.preloader.show();
		var formData = $f7.form.convertToData('#filterPromo');
		$f7.request.postJSON(apiServer+'promo', formData).then(function (res) {
			if(res.data){
				if(res.data.err){
					$f7.preloader.hide();
					$store.dispatch('msgalert', {err: res.data.err});
				} else {
					data = res.data;
					promolist = data;
					$update();
					$f7.preloader.hide();
				}
			} else {
				$f7.preloader.hide();
				$store.dispatch('msgalert', {err: 'Попробуйте позже.'});
			}
		});
	}
	function promocode(e){
		getcode = e.target.getAttribute('code');
		navigator.clipboard.writeText(getcode)
		.then(
			() => $store.dispatch('msgalert', {err: 'Промокод успешно скопирован.'})
		).catch(
			err => $store.dispatch('msgalert', {err: 'Функция копирования недоступна в вашем браузере.'})
		);
	}
	function sendMissinganimal(){
		let formData = $f7.form.convertToData('#missinganimal');

		let shortdesc = $f7.textEditor.get('#missinganimal .missinganimaltext');
		formData['text'] = shortdesc.value;

		fetch(apiServer+'services/missinganimal', {
			method: 'POST',
			body: JSON.stringify(formData),
			headers: headers()
		})
		.then((res) => res.json())
		.then(function (data) {
			if(data.err){
				$f7.preloader.hide();
				$store.dispatch('msgalert', {
					err: data.err
				});
			} else {
				$f7.sheet.close('.modal-missinganimal');
				$store.dispatch('msgalert', {
					err: 'Заявка оформлена. В ближайшее время с вами свяжется менеджер.'
				});

			}
		});
	}
	function getMyMissinganimal(){
		fetch(apiServer+'services/mymissinganimal', {
			method: 'POST',
			body: JSON.stringify(),
			headers: headers()
		})
		.then((res) => res.json())
		.then(function (data) {
			if(data.err){
			} else {
				missinganimalList = data;
				for(var k in missinganimalList) {
					if(missinganimalList[k]){
						if(missinganimalList[k].create){
							missinganimalList[k].date = moment(missinganimalList[k].create, "YYYYMMDD").format('D MMMM YYYY');
						}
				   }
			   }
			   $update();
			}
		});
	}
	function showVeterinaryClinics(){
		$f7.sheet.open('.modal-veterinary-clinics');
		ymaps.option.presetStorage.add('my#maphidden', {iconImageHref:'assets/icon_maphidden.svg', iconImageSize: [10, 10], iconLayout: 'default#image'});
		ymaps.option.presetStorage.add('my#mapbase', {iconImageHref:'assets/icon_map.svg', iconImageSize: [30, 40], iconLayout: 'default#image'});
		ymaps.option.presetStorage.add('my#mapislands', {iconImageHref:'assets/icon_map_islands.svg', iconImageSize: [40, 40], iconLayout: 'default#image'});
		if($('#veterinaryclinicsmap > ymaps').length){

			} else {

			if(typeof myMap === 'undefined'){

				var geolocation = ymaps.geolocation,
				myMap = new ymaps.Map('veterinaryclinicsmap', {
					center: [53.894, 27.554],
					zoom: 10
				}, {
					searchControlProvider: 'yandex#search'
				});


				geolocation.get({
					provider: 'browser',
					mapStateAutoApply: true
				}).then(function (result) {
					// Синим цветом пометим положение, полученное через браузер.
					// Если браузер не поддерживает эту функциональность, метка не будет добавлена на карту.
					result.geoObjects.options.set('preset', 'my#maphidden');
					myMap.geoObjects.add(result.geoObjects);
				});

				objectManager = new ymaps.ObjectManager({
					// Чтобы метки начали кластеризоваться, выставляем опцию.
					clusterize: true,
					// ObjectManager принимает те же опции, что и кластеризатор.
					gridSize: 64,
					clusterDisableClickZoom: true
				});



				objectManager.objects.options.set('preset', 'my#mapbase');
				objectManager.clusters.options.set('preset', 'islands#orangeClusterIcons');


				myMap.geoObjects.add(objectManager);

				// Создаем геообъект с типом геометрии "Точка".
				myGeoObject = new ymaps.GeoObject({
					// Описание геометрии.
					geometry: {
						type: "Point",
						coordinates: [55.8, 37.8]
					},
				}, {
					// Опции.
					// Иконка метки будет растягиваться под размер ее содержимого.
					preset: 'islands#blackStretchyIcon',
					// Метку можно перемещать.
					draggable: true
				});


				fetch(apiServer+'vetclinics', {
					method: 'POST',
					body: JSON.stringify(),
					headers: headers()
				})
				.then((res) => res.json())
				.then(function (data) {
					if(data.err){
					} else {
						mapdata = data.features;
						maplist['count'] = mapdata.length + ' ' + declOfNum(mapdata.length, ['адрес', 'адреса', 'адресов']);
						maplistdata = mapdata;

						objectManager.add(data);

						$update();
					}
				});

			} else {
			}


		}

	}
	$on("pageInit", function (e, page) {
		startLoadPromo();

		$('#filterPromo [name="filter"]').on('change', function(e) {
			startLoadPromo();
		});

		var textEditor = $f7.textEditor.create({
			el: '.modal-missinganimal .missinganimaltext2',
			buttons: [],
			clearFormattingOnPaste: true,
			customButtons: {}
		});
		getMyMissinganimal();




	});
    return $render;
}
</script>
