<template>
    <div class="page">
        <div class="page service">
            <div class="page-content">
                <div class="head">
                    <div class="container">
                        <div class="row">
                            <div class="col-100 small-100 medium-100 large-100 xlarge-100">
                                <h1 class="headTitle">Услуги</h1>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="">
                    <div class="container">
                        <div class="row">
                            <div class="col-100 small-100 medium-100 large-100 xlarge-100">
                                <div id="zooid" class="page-content">
                                    <div class="wrap">
                                        <div class="serviceslist">
                                            <div class="row">
                                                <div class="item">
                                                    <div class="row">
                                                        <div class="col-100 data">
                                                            <div>
                                                                <div class="name">Сообщить о пропаже</div>
                                                            </div>
                                                            <div>
                                                                <div class="action">
                                                                    <a class="external" href="tel:88011008080">Позвонить
                                                                        <img src="assets/icon_more.svg"/></a>
                                                                    <div class="" @click=${missinganimal}>Оставить
                                                                        заявку <img src="assets/icon_more.svg"/>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
<!--                                                <div class="item">-->
<!--                                                    <div class="row">-->
<!--                                                        <div class="col-100 data" @click=${showVeterinaryClinics}>-->
<!--                                                            <div>-->
<!--                                                                <div class="name">Информация о вет. клиниках</div>-->
<!--                                                            </div>-->
<!--                                                            <div>-->
<!--                                                                <div class="action">-->
<!--                                                                    <div class="">Выбрать <img-->
<!--                                                                            src="assets/icon_more.svg"/></div>-->
<!--                                                                </div>-->
<!--                                                            </div>-->
<!--                                                        </div>-->
<!--                                                    </div>-->
<!--                                                </div>-->
<!--                                                <div class="item" data-id="1" @click=${showVeterinaryShops}>-->
<!--                                                    <div class="row">-->
<!--                                                        <div class="col-100 data">-->
<!--                                                            <div>-->
<!--                                                                <div class="name">Информация о Зоомагазинах</div>-->
<!--                                                            </div>-->
<!--                                                            <div>-->
<!--                                                                <div class="action">-->
<!--                                                                    <div class="">Выбрать <img-->
<!--                                                                            src="assets/icon_more.svg"/></div>-->
<!--                                                                </div>-->
<!--                                                            </div>-->
<!--                                                        </div>-->
<!--                                                    </div>-->
<!--                                                </div>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet-modal modal-missinganimal">
                <div class="hat"><a class="link sheet-close" href="#"></a></div>
                <div class="sheet-modal-inner">

                    <div class="info">
                        <div class="title">Сообщить о пропаже</div>
                    </div>
                    <form class="userforms" id="missinganimal" name="missinganimal">
                        <div class="сonditions" style="gap: 0px;">
                            <div class="name" style="margin-bottom: 0px;">Расскажите что произошло</div>
                            <div class="flexzone" style="max-width: 450px; padding-bottom: 20px;">
                                <textarea name="text" style="height: auto;padding: 15px 25px;width: 100%;"></textarea>
                            </div>
                            <div class="name" style="margin-bottom: 0px;">Адрес где пропал питомец</div>
                            <div class="flexzone" style="max-width: 450px; padding-bottom: 20px;">
                                <textarea name="address"
                                          style="height: auto;padding: 15px 25px;width: 100%;">${address}</textarea>
                            </div>
                            <div id="missingpetmap"></div>
                        </div>
                    </form>
                    <div class="sendform sendform-missing-pet">
                        <div class="promolink"><a href="#" class="col button button-fill link"
                                                  @click=${sendMissinganimal}>Отправить заявку</a></div>
                    </div>
                </div>
            </div>
<!--            <div class="sheet-modal modal-veterinary-clinics">-->
<!--                <div class="hat"><a class="link sheet-close" href="#"></a></div>-->
<!--                <div class="sheet-modal-inner">-->
<!--                    <div class="info">-->
<!--                        <div class="title">Информация о вет. клиниках</div>-->
<!--                        <div class="desc">Мы выступаем посредником между клиниками и вами. Предоставляем сервис, где вы-->
<!--                            в одном месте можете получить всю нужную для себя информацию-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="headmap row">-->
<!--                        <div class="col-50">-->
<!--                            <div class="title">Адреса</div>-->
<!--                        </div>-->
<!--                        <div class="col-50">-->
<!--                            <div class="desc count">${maplist.count}</div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="segmented">-->
<!--                        <a href="#clinicsyandex" class="tab-link button tab-link-active">Карта</a>-->
<!--                        <a href="#clinicslist" class="tab-link button">Список</a>-->
<!--                    </div>-->
<!--                    <div class="tabs">-->
<!--                        <div class="tab tab-active" id="clinicsyandex">-->
<!--                            <div id="veterinaryclinicsmap"></div>-->
<!--                        </div>-->
<!--                        <div class="tab" id="clinicslist">-->
<!--                            <div class="clinicscards row">-->
<!--                                ${maplistdata.map((data, index) => $h`-->
<!--                                <a href="${data.link}" target="_blank" class="col-50 link external card">-->
<!--                                    <div class="name">${data.name}</div>-->
<!--                                    <div class="time" innerHTML=${data.timework}></div>-->
<!--                                    <div class="addr">${data.addr}</div>-->
<!--                                    <div class="link">Перейти на сайт</div>-->
<!--                                </a>-->

<!--                                `)}-->
<!--                            </div>-->
<!--                        </div>-->

<!--                    </div>-->

<!--                </div>-->
<!--            </div>-->
<!--            <div class="sheet-modal modal-veterinary-shops">-->
<!--                <div class="hat"><a class="link sheet-close" href="#"></a></div>-->
<!--                <div class="sheet-modal-inner">-->
<!--                    <div class="info">-->
<!--                        <div class="title">Информация о зоомагазинах</div>-->
<!--                        <div class="desc">Мы выступаем посредником между зоомагазинами и вами. Предоставляем сервис, где-->
<!--                            вы-->
<!--                            в одном месте можете получить всю нужную для себя информацию-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="headmap row">-->
<!--                        <div class="col-50">-->
<!--                            <div class="title">Адреса</div>-->
<!--                        </div>-->
<!--                        <div class="col-50">-->
<!--                            <div class="desc count">${mapshoplist.count}</div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="segmented">-->
<!--                        <a href="#shopsyandex" class="tab-link button tab-link-active">Карта</a>-->
<!--                        <a href="#shopslist" class="tab-link button">Список</a>-->
<!--                    </div>-->
<!--                    <div class="tabs">-->
<!--                        <div class="tab tab-active" id="shopsyandex">-->
<!--                            <div id="veterinaryshopsmap"></div>-->
<!--                        </div>-->

<!--                        <div class="tab" id="shopslist">-->
<!--                            <div class="clinicscards row">-->
<!--                                ${mapshoplistdata.map((data, index) => $h`-->
<!--                                <a href="${data.link}" target="_blank" class="col-50 link external card">-->
<!--                                    <div class="name">${data.name}</div>-->
<!--                                    <div class="time" innerHTML=${data.time_work}></div>-->
<!--                                    <div class="addr">${data.address}</div>-->
<!--                                    <div class="link">Перейти на сайт</div>-->
<!--                                </a>-->

<!--                                `)}-->
<!--                            </div>-->
<!--                        </div>-->

<!--                    </div>-->

<!--                </div>-->
<!--            </div>-->
        </div>
        <div class="page promo">
            <div class="page-content">
                <div class="head">
                    <div class="container">
                        <div class="row">
                            <div class="col-100 small-100 medium-100 large-100 xlarge-100">
                                <h1 class="headTitle">Скидки и бонусы Партнеров - Скоро будет!</h1>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="">
                    <div class="container">
                        <form class="filter" id="filterPromo" name="filterPromo">
                            <label class="item-checkbox item-content">
                                <input type="checkbox" name="tags" value="1"/>
                                <div class="item-inner">
                                    <div class="item-title">Новое</div>
                                </div>
                            </label>
                            <label class="item-checkbox item-content">
                                <input type="checkbox" name="tags" value="2"/>
                                <div class="item-inner">
                                    <div class="item-title">Корма</div>
                                </div>
                            </label>
                            <label class="item-checkbox item-content">
                                <input type="checkbox" name="tags" value="3"/>
                                <div class="item-inner">
                                    <div class="item-title">Зоотовары</div>
                                </div>
                            </label>
                        </form>

                        <div class="mobile-hidden">
                            <div class="promolist">
                                <div class="row">
                                    ${promolist.map((data, index) => $h`
                                    ${data.type == 1 ? $h`
                                    <a href="#" class="item huge link opacityHover" data-id="${data.id}">
                                        <div class="row">
                                            <div class="col-100 whitebg">
                                                <div class="media"
                                                     style="background-image: url(https://api.sergivanov.ru/media/orig/${data.media});"></div>
                                            </div>
                                            <div class="col-100 data">
                                                <div>
                                                    <div class="name">${data.title}</div>
                                                    <div class="info">
                                                        <div class="sale">${data.percent}%</div>
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="more">Скоро <img src="assets/icon_more.svg"/></div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    ` : `
                                    `}
                                    ${data.type == 2 ? data.size == 1 ? $h`
                                    <a href="#" class="item small link opacityHover" data-id="${data.id}">
                                        <div class="row">
                                            <div class="col-100 data">
                                                <div>
                                                    <div class="name">${data.title}</div>
                                                    <div class="info">
                                                        <div class="sale">${data.percent}%</div>
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="more">Скоро <img src="assets/icon_more_orange.svg"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    ` : $h`
                                    <a href="#" class="item big link opacityHover" data-id="${data.id}">
                                        <div class="row">
                                            <div class="col-100 data">
                                                <div>
                                                    <div class="name">${data.title}</div>
                                                    <div class="info">
                                                        <div class="sale">${data.percent}%</div>
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="more">Скоро <img src="assets/icon_more_orange.svg"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    ` : `
                                    `}
                                    `)}
                                </div>
                            </div>
                        </div>
                        <div class="desktop-hidden">
                            <div class="promolist">
                                <div class="row">
                                    ${promolist.map((data, index) => $h`
                                    ${data.type == 1 ? $h`
                                    <a href="#" class="item link big opacityHover">
                                        <div class="row">
                                            <div class="col-100 whitebg" style="width: 100%;height: 250px;">
                                                <div class="media" style="background-position: 50%;
    width: 100%;
    height: 100%;
    background-repeat: no-repeat;
    background-size: contain;
    margin: 0 auto;background-image: url(https://api.sergivanov.ru/media/orig/${data.media});"></div>
                                            </div>
                                            <div class="col-100 data" style="height: 250px;background-color:#eb6130;">
                                                <div>
                                                    <div style="color:white;font-family: 'Stratos LC Web';
                                                               font-size: 24px;line-height: 30px;
                                                               ">${data.title}</div>
                                                    <div  style="color:white;font-family: 'Stratos LC Web';
                                                               font-size: 16px;line-height: 20px;
                                                               ">
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div style="color:white;font-family: 'Stratos LC Web';
                                                               font-size: 16px;line-height: 20px;
                                                               ">Скоро <img src="assets/icon_more.svg"/></div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    <!--                                    <a href="#" class="item huge link opacityHover" data-id="${data.id}">-->
                                    <!--                                        <div class="row">-->
                                    <!--                                            <div class="col-100 whitebg">-->
                                    <!--                                                <div class="media" style="background-image: url(https://api.sergivanov.ru/media/orig/${data.media});"></div>-->
                                    <!--                                            </div>-->
                                    <!--                                            <div class="col-100 data">-->
                                    <!--                                                <div>-->
                                    <!--                                                    <div class="name">${data.title}</div>-->
                                    <!--                                                    <div class="info">-->
                                    <!--                                                        <div class="sale">${data.percent}%</div>-->
                                    <!--                                                        ${data.shortdesc}-->
                                    <!--                                                    </div>-->
                                    <!--                                                </div>-->
                                    <!--                                                <div>-->
                                    <!--                                                    <div class="more">Скоро <img src="assets/icon_more.svg"/></div>-->
                                    <!--                                                </div>-->
                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                    <!--                                    </a>-->
                                    ` : `
                                    `}
                                    ${data.type == 2 ? data.size == 1 ? $h`
                                    <a href="#" class="item small link opacityHover" data-id="${data.id}">
                                        <div class="row">
                                            <div class="col-100 data">
                                                <div>
                                                    <div class="name">${data.title}</div>
                                                    <div class="info">
                                                        <div class="sale">${data.percent}%</div>
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="more">Скоро <img src="assets/icon_more_orange.svg"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    ` : $h`
                                    <a href="#" class="item big link opacityHover" data-id="${data.id}">
                                        <div class="row">
                                            <div class="col-100 data">
                                                <div>
                                                    <div class="name">${data.title}</div>
                                                    <div class="info">
                                                        <div class="sale">${data.percent}%</div>
                                                        ${data.shortdesc}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="more">Скоро <img src="assets/icon_more_orange.svg"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                    ` : `
                                    `}
                                    `)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet-modal modal-promoinfo">
                <div class="hat"><a class="link sheet-close" href="#"></a></div>
                <div class="sheet-modal-inner">

                    <div class="info">
                        <div class="title">${promo.title}</div>
                        <div class="shortdesc">
                            <div class="sale"> ${promo.percent}%</div>
                            ${promo.shortdesc}
                        </div>
                        <div class="time">До ${promo.stoptextdata} (${promo.stoptext})</div>
                    </div>
                    <div class="gotocode">
                        <div class="promocode link" style="margin: 20px 0;" @click=${()=> promocode(promo.promocode)}>
                            <div class="label">Промокод</div>
                            <div class="pers" style="margin:0 5px;"> ${promo.percent}%</div>
                            <img class="copy" src="assets/icon_copy.svg"/>
                        </div>
                        <div class="promolink"><a href="${promo.promolink}" target="_blank"
                                                  class="col button button-fill external link">К покупкам</a></div>
                    </div>
                    <div class="сonditions">
                        <div>
                            <div class="title">Условия</div>
                            <div class="desc" innerHTML=${promo.сonditions}></div>
                        </div>
                        <div>
                            <div class="other">Срок действия</div>
                            <div class="desc">${promo.starttextdata} - ${promo.stoptextdata} (${promo.stoptext})</div>
                        </div>
                        <div>
                            <div class="other">Минимальная сумма покупки</div>
                            <div class="desc upp">${promo.minprice} ${promo.currency}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
<script>

    export default (props, {
        $f7,
        $f7router,
        $el,
        $update,
        $on,
        $onBeforeMount,
        $onMounted,
        $onBeforeUpdate,
        $onUpdated,
        $onBeforeUnmount,
        $onUnmounted,
        $store
    }) => {
        let promolist = [];
        let promo = [];
        let maplist = [];
        let maplistdata = [];
        let mapshoplist = [];
        let mapshoplistdata = [];
        let latitude = '';
        let longitude = '';
        let address = '';

        maplist['count'] = '0 адресов';
        mapshoplist['count'] = '0 адресов';

        function missinganimal() {
            $f7.sheet.open('.modal-missinganimal');
        }

        function showPromo(e) {
            app.preloader.show();
            let getid = e.target.getAttribute('data-id');
            app.request.postJSON(apiServer + 'promo', {id: getid}).then(function (res) {
                if (res.data) {
                    if (res.data.err) {
                        app.preloader.hide();
                        $store.dispatch('msgalert', {err: res.data.err});
                    } else {
                        app.preloader.hide();
                        let data = res.data;


                        data.stoptext = moment(data.stop, "YYYYMMDD").fromNow();
                        data.stoptextdata = moment(data.stop, "YYYYMMDD").format('D MMMM');

                        data.starttext = moment(data.start, "YYYYMMDD").fromNow();
                        data.starttextdata = moment(data.start, "YYYYMMDD").format('D MMMM');
                        promo = data;
                        $update();
                        app.sheet.open('.modal-promoinfo');
                    }
                } else {
                    app.preloader.hide();
                    $store.dispatch('msgalert', {err: 'Попробуйте позже.'});
                }
            });
        };

        function startLoadPromo() {
            app.preloader.show();
            var formData = $f7.form.convertToData('#filterPromo');
            app.request.postJSON(apiServer + 'promo', formData).then(function (res) {
                if (res.data) {
                    if (res.data.err) {
                        app.preloader.hide();
                        $store.dispatch('msgalert', {err: res.data.err});
                    } else {
                        let data = res.data;
                        promolist = data;
                        $update();
                        app.preloader.hide();
                    }
                } else {
                    app.preloader.hide();
                    $store.dispatch('msgalert', {err: 'Попробуйте позже.'});
                }
            });
        }

        function promocode(code) {
            navigator.clipboard.writeText(code)
                .then(
                    () => $store.dispatch('msgalert', {err: 'Промокод успешно скопирован.'})
                ).catch(
                err => $store.dispatch('msgalert', {err: 'Функция копирования недоступна в вашем браузере.'})
            );
        }

        function sendMissinganimal() {
            let formData = $f7.form.convertToData('#missinganimal');

            if ($('[name="address"]').val() === '') {
                $f7.store.dispatch('toast', {
                    text: 'Заполните поле адрес.'
                });
                return false;
            }

            formData['longitude'] = longitude;
            formData['latitude'] = latitude;
            formData['address'] = address;

            fetch(apiServer + 'services/missinganimal', {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: headers()
            })
                .then((res) => res.json())
                .then(function (data) {
                    if (data.err) {
                        $f7.preloader.hide();
                        $store.dispatch('msgalert', {
                            err: data.err
                        });
                    } else {
                        $f7.sheet.close('.modal-missinganimal');
                        $store.dispatch('msgalert', {
                            err: 'Заявка оформлена. В ближайшее время с вами свяжется менеджер.'
                        });

                    }
                });
        }

        function showVeterinaryShops() {
            $f7.sheet.open('.modal-veterinary-shops');
            ymaps.option.presetStorage.add('my#mapbase', {
                iconImageHref: 'assets/icon_map.svg',
                iconImageSize: [30, 40],
                iconLayout: 'default#image'
            });
            ymaps.option.presetStorage.add('my#mapislands', {
                iconImageHref: 'assets/icon_map_islands.svg',
                iconImageSize: [40, 40],
                iconLayout: 'default#image'
            });
            if ($('#veterinaryshopsmap > ymaps').length) {
            } else {
                if (typeof myMap === 'undefined') {

                    var geolocation = ymaps.geolocation,
                        myMap = new ymaps.Map('veterinaryshopsmap', {
                            center: [53.905971, 27.556458],
                            zoom: 10
                        }, {
                            searchControlProvider: 'yandex#search'
                        });


                    geolocation.get({
                        provider: 'browser',
                        mapStateAutoApply: true
                    }).then(function (result) {
                        // Синим цветом пометим положение, полученное через браузер.
                        // Если браузер не поддерживает эту функциональность, метка не будет добавлена на карту.
                        result.geoObjects.options.set('preset', 'my#maphidden');
                        myMap.geoObjects.add(result.geoObjects);
                    });

                    let objectManager = new ymaps.ObjectManager({
                        // Чтобы метки начали кластеризоваться, выставляем опцию.
                        clusterize: true,
                        // ObjectManager принимает те же опции, что и кластеризатор.
                        gridSize: 64,
                        clusterDisableClickZoom: true
                    });


                    objectManager.objects.options.set('preset', 'my#mapbase');
                    objectManager.clusters.options.set('preset', 'islands#orangeClusterIcons');


                    myMap.geoObjects.add(objectManager);

                    // Создаем геообъект с типом геометрии "Точка".
                    let myGeoObject = new ymaps.GeoObject({
                        // Описание геометрии.
                        geometry: {
                            type: "Point",
                            coordinates: [53.905971, 27.556458]
                        },
                    }, {
                        // Опции.
                        // Иконка метки будет растягиваться под размер ее содержимого.
                        preset: 'islands#blackStretchyIcon',
                        // Метку можно перемещать.
                        draggable: true
                    });


                    fetch(apiServer + 'pet-shops/list', {
                        method: 'POST',
                        body: JSON.stringify(),
                        headers: headers()
                    })
                        .then((res) => res.json())
                        .then(function (data) {
                            if (data.err) {
                            } else {
                                let shopdata = data.features;
                                mapshoplist['count'] = shopdata.length + ' ' + declOfNum(shopdata.length, ['адрес', 'адреса', 'адресов']);
                                mapshoplistdata = shopdata;
                                objectManager.add(data);
                                $update();
                            }
                        });

                } else {
                }
            }
        }

        function loadmap() {
            let mapCenter = [53.905971, 27.556458];

            let zoom = 12;

            var map = new ymaps.Map('missingpetmap', {
                center: mapCenter,
                zoom: zoom
            }, {
                searchControlNoPlacemark: true
            });

            ymaps.modules.require([
                'GeoObjectEditor',
                'MapStateInfo',
                'DemoControl'
            ]).spread(function (GeoObjectEditor, MapStateInfo, DemoControl) {
                map.controls.add(new DemoControl({coordOrder: coordOrder}));
            });

            map.events.add('click', function (e) {
                if (!map.balloon.isOpen()) {
                    var coords = e.get('coords');
                    latitude = coords[0].toPrecision(8);
                    longitude = coords[1].toPrecision(8);


                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords[0].toPrecision(8)}&lon=${coords[1].toPrecision(8)}`;

                    try {
                        getAddressFromCoords(coords[0].toPrecision(8), coords[1].toPrecision(8)).then(function (str) {
                            address = str;
                            map.balloon.open(coords, {
                                contentHeader: 'Адрес где пропал питомец',
                                contentBody: '' +
                                    '<p>Данные точки: ' + str + '</p>',
                            });
                            $update();
                        });
                    } catch (error) {
                        console.error('Ошибка:', error);
                        return null;
                    }
                    $update();

                } else {
                    map.balloon.close();
                }
            });

            map.events.add('balloonopen', function (e) {
                map.hint.close();
            });
        }

        function showVeterinaryClinics() {
            $f7.sheet.open('.modal-veterinary-clinics');
            ymaps.option.presetStorage.add('my#mapbase', {
                iconImageHref: 'assets/icon_map.svg',
                iconImageSize: [30, 40],
                iconLayout: 'default#image'
            });
            ymaps.option.presetStorage.add('my#mapislands', {
                iconImageHref: 'assets/icon_map_islands.svg',
                iconImageSize: [40, 40],
                iconLayout: 'default#image'
            });
            if ($('#veterinaryclinicsmap > ymaps').length) {
            } else {
                if (typeof myMap === 'undefined') {

                    var geolocation = ymaps.geolocation,
                        myMap = new ymaps.Map('veterinaryclinicsmap', {
                            center: [53.905971, 27.556458],
                            zoom: 10
                        }, {
                            searchControlProvider: 'yandex#search'
                        });


                    geolocation.get({
                        provider: 'browser',
                        mapStateAutoApply: true
                    }).then(function (result) {
                        // Синим цветом пометим положение, полученное через браузер.
                        // Если браузер не поддерживает эту функциональность, метка не будет добавлена на карту.
                        result.geoObjects.options.set('preset', 'my#maphidden');
                        myMap.geoObjects.add(result.geoObjects);
                    });

                    objectManager = new ymaps.ObjectManager({
                        // Чтобы метки начали кластеризоваться, выставляем опцию.
                        clusterize: true,
                        // ObjectManager принимает те же опции, что и кластеризатор.
                        gridSize: 64,
                        clusterDisableClickZoom: true
                    });


                    objectManager.objects.options.set('preset', 'my#mapbase');
                    objectManager.clusters.options.set('preset', 'islands#orangeClusterIcons');


                    myMap.geoObjects.add(objectManager);

                    // Создаем геообъект с типом геометрии "Точка".
                    myGeoObject = new ymaps.GeoObject({
                        // Описание геометрии.
                        geometry: {
                            type: "Point",
                            coordinates: [55.8, 37.8]
                        },
                    }, {
                        // Опции.
                        // Иконка метки будет растягиваться под размер ее содержимого.
                        preset: 'islands#blackStretchyIcon',
                        // Метку можно перемещать.
                        draggable: true
                    });


                    fetch(apiServer + 'vetclinics', {
                        method: 'POST',
                        body: JSON.stringify(),
                        headers: headers()
                    })
                        .then((res) => res.json())
                        .then(function (data) {
                            if (data.err) {
                            } else {
                                mapdata = data.features;
                                maplist['count'] = mapdata.length + ' ' + declOfNum(mapdata.length, ['адрес', 'адреса', 'адресов']);
                                maplistdata = mapdata;

                                objectManager.add(data);

                                $update();
                            }
                        });

                } else {
                }
            }
        }

        $on("pageInit", function (e, page) {

            if (!$f7.form.getFormData('token')) {
                location.href = '/login'
            }

            startLoadPromo();

            setTimeout(function (){
                loadmap();
            }, 1000)

            $('#filterPromo [name="tags"]').on('change', function (e) {
                startLoadPromo();
            });
        });

        async function getAddressFromCoords(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

            try {
                const response = await fetch(url, {headers: {'User-Agent': 'MyApp'}});
                const data = await response.json();
                return data.display_name || 'Адрес не найден';
            } catch (error) {
                console.error('Ошибка:', error);
                return null;
            }
        }


        return $render;
    }
</script>
